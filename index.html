<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Picture-Word Match</title>
  <style>
    /* ===== „É¨„Ç§„Ç¢„Ç¶„Éà ===== */
    *{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
    body{margin:0;background:#f0f8ff}
    #container{display:flex;flex-direction:column;align-items:center;padding:20px}
    h1{margin-bottom:20px}

    /* ===== „Éú„Çø„É≥ÔºèUI ===== */
    button{cursor:pointer;border:none;border-radius:8px;padding:10px 18px;
           font-size:1rem;background:#2196f3;color:#fff}
    #modeBtns{display:flex;gap:20px}
    #gameControls{display:flex;gap:12px;margin-bottom:16px;justify-content:center;
                  width:100%;padding:10px;flex-wrap:wrap}
    #timer{font-weight:bold;font-size:1.1rem;color:#d32f2f}

    /* ===== „Ç≤„Éº„É†„Ç®„É™„Ç¢ ===== */
    #gameArea{display:flex;width:100%;max-width:1200px}
    .area{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;width:50%;padding:0 10px}
    .img-card,.word-card{width:100%;height:100px;border-radius:12px;display:flex;
                         align-items:center;justify-content:center;user-select:none;
                         touch-action:none;transition:transform .25s}
    .img-card{font-size:2.2rem;background:#fff3e0;border:3px solid #ffb74d}
    .word-card{font-size:.9rem;background:#e3f2fd;border:3px solid #64b5f6;
               cursor:grab;padding:6px;text-align:center;line-height:1.15}
    .matched{opacity:.35;cursor:default}

    /* ===== „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ ===== */
    @keyframes flash{from{background:#c8e6c9}to{background:#fff3e0}}
    @keyframes shake{10%,90%{transform:translateX(-4px)}
                     20%,80%{transform:translateX(4px)}
                     30%,50%,70%{transform:translateX(-4px)}
                     40%,60%{transform:translateX(4px)}}
    .correct-anim{animation:flash .3s}
    .wrong-anim{animation:shake .35s}

    /* ===== „Çπ„Éû„Éõ„É¨„Ç§„Ç¢„Ç¶„Éà ===== */
    @media(max-width:480px){
      #gameArea{flex-wrap:wrap}
      .area{width:100%;grid-template-columns:repeat(2,1fr);gap:8px}
      .img-card,.word-card{height:80px}
      .img-card{font-size:1.8rem}
      .word-card{font-size:.75rem;padding:4px}
    }
  </style>
</head>
<body>
<div id="container">

  <!-- „Çπ„Çø„Éº„ÉàÁîªÈù¢ -->
  <div id="startScreen">
    <h1>Picture-Word Match</h1>
    <div id="modeBtns">
      <button id="practiceBtn">Practice&nbsp;Mode</button>
      <button id="trialBtn">30-Set&nbsp;Trial&nbsp;Mode</button>
    </div>
  </div>

  <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
  <div id="gameScreen" style="display:none;width:100%;flex-direction:column;align-items:center;">
    <div id="gameControls">
      <select id="categorySelect"></select>
      <button id="startCategoryBtn">Start</button>
      <button id="backBtn">Back</button>
      <span id="timer" style="display:none;margin-left:20px;"></span>
    </div>
    <div id="gameArea">
      <div id="imageArea" class="area"></div>
      <div id="wordArea"  class="area"></div>
    </div>
  </div>

</div>

<script>
/* ---------- iOS Èü≥Â£∞„É≠„ÉÉ„ÇØËß£Èô§ & „Éú„Ç§„Çπ„É≠„Éº„Éâ ---------- */
const voicesReady = new Promise(res=>{
  if(speechSynthesis.getVoices().length) return res();
  speechSynthesis.onvoiceschanged = res;
});
function unlockIOS(){
  if(window._iosUnlocked) return;
  window._iosUnlocked = true;

  /* ÁÑ°Èü≥ ping (AudioContext) */
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    osc.connect(ctx.destination);
    osc.start(); osc.stop();
  }catch{}

  /* ÁÑ°Èü≥ utterance */
  voicesReady.then(()=>{
    const u = new SpeechSynthesisUtterance('ready');
    u.lang='en-US'; u.volume=0;
    speechSynthesis.speak(u);
  });
}
['touchstart','mousedown','keydown'].forEach(ev=>{
  document.addEventListener(ev,unlockIOS,{once:true});
});

/* ---------- Èü≥Â£∞ÂÜçÁîü ---------- */
function speak(text){
  voicesReady.then(()=>{
    speechSynthesis.cancel();
    speechSynthesis.resume();           // Safari ÂØæÁ≠ñ
    const ut = new SpeechSynthesisUtterance(text);
    ut.lang = 'en-US';
    ut.voice = speechSynthesis.getVoices().find(v=>v.lang.startsWith('en')) || null;
    speechSynthesis.speak(ut);
  });
}

/* ---------- ÂÜ†Ë©û‰ªò‰∏é„É≠„Ç∏„ÉÉ„ÇØ ---------- */
function addArticle(word){
  // 1) ÊñáÔºàÁ©∫ÁôΩ„ÇíÂê´„ÇÄ or „Éî„É™„Ç™„Éâ„ÄÜÔºâ‚Üí „Åù„ÅÆ„Åæ„Åæ
  if(/\s/.test(word) || word.endsWith('.')) return word;

  // 2) ÂÜ†Ë©û‰∏çË¶ÅË™û„É™„Çπ„Éà
  const noArticle = [
    "bread","rice","milk",                           // ‰∏çÂèØÁÆó
    "red","blue","green","yellow","black","white","orange","purple","brown", // Ëâ≤
    "sunny","rainy","windy","cloudy","snowy",        // Â§©Ê∞ó
    "one","two","three","four","five","six","seven","eight","nine",
    "ten","eleven","twelve"                          // Êï∞Â≠ó
  ];
  if(noArticle.includes(word.toLowerCase())) return word;

  // 3) Ë§áÊï∞ÂΩ¢ÔºàË™ûÂ∞æ sÔºâ‚Üí „Åù„ÅÆ„Åæ„Åæ
  if(word.toLowerCase().endsWith('s')) return word;

  // 4) „Åù„Çå‰ª•Â§ñ ‚Üí a / an
  return /^[aeiou]/i.test(word) ? `an ${word}` : `a ${word}`;
}

/* ---------- „Éá„Éº„Çø ---------- */
const wordsByCat = {
  Food:["apple","bread","milk","rice","egg","apples","eggs"],
  Animals:["dog","cat","bird","elephant","dogs","cats","birds","elephants"],
  School:["book","pen","pencil","chair","bag","books","pens","pencils","chairs","bags"],
  Family:["mother","father","sister","brother","grandpa"],
  Clothes:["shirt","shirts","pants","shoes","coat","coats","hat","hats"],
  Colors:["red","blue","green","yellow","black","white","orange","purple","brown"],
  Numbers:["one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve"],
  Weather:["sunny","rainy","windy","cloudy","snowy"],
  Actions:["I sleep.","I run.","I drink juice.","I brush my teeth.","I eat sushi."],
  Feelings:["I am happy.","I am sad.","I am tired.","I am hungry.","I am angry."]
};
const emoji = {
  apple:"üçé",apples:"üçéüçé",bread:"üçû",milk:"ü•õ",rice:"üçö",egg:"ü•ö",eggs:"ü•öü•ö",
  dog:"üê∂",dogs:"üê∂üê∂",cat:"üê±",cats:"üê±üê±",bird:"üê¶",birds:"üê¶üê¶",elephant:"üêò",elephants:"üêòüêò",
  book:"üìï",books:"üìïüìï",pen:"üñäÔ∏è",pens:"üñäÔ∏èüñäÔ∏è",pencil:"‚úèÔ∏è",pencils:"‚úèÔ∏è‚úèÔ∏è",chair:"ü™ë",chairs:"ü™ëü™ë",bag:"üéí",bags:"üéíüéí",
  mother:"üë©",father:"üë®",sister:"üëß",brother:"üë¶",grandpa:"üë¥",
  shirt:"üëï",shirts:"üëïüëï",pants:"üëñ",shoes:"üëüüëü",coat:"üß•",coats:"üß•üß•",hat:"üé©",hats:"üé©üé©",
  red:"üü•",blue:"üü¶",green:"üü©",yellow:"üü®",black:"‚¨õ",white:"‚¨ú",orange:"üüß",purple:"üü™",brown:"üü´",
  one:"1Ô∏è‚É£",two:"2Ô∏è‚É£",three:"3Ô∏è‚É£",four:"4Ô∏è‚É£",five:"5Ô∏è‚É£",six:"6Ô∏è‚É£",seven:"7Ô∏è‚É£",eight:"8Ô∏è‚É£",nine:"9Ô∏è‚É£",ten:"üîü",
  eleven:"1Ô∏è‚É£1Ô∏è‚É£",twelve:"1Ô∏è‚É£2Ô∏è‚É£",
  sunny:"‚òÄÔ∏è",rainy:"üåßÔ∏è",windy:"üå¨Ô∏è",cloudy:"‚òÅÔ∏è",snowy:"‚ùÑÔ∏è",
  "I sleep.":"üò¥","I run.":"üèÉ","I drink juice.":"üßÉ",
  "I brush my teeth.":"ü™•ü¶∑","I eat sushi.":"üç£ü•¢",
  "I am happy.":"üòä","I am sad.":"üò¢","I am tired.":"ü•±",
  "I am hungry.":"ü§§","I am angry.":"üò†"
};

/* ---------- Áä∂ÊÖã ---------- */
let draggedWord=null, touchClone=null, timerInt=null;

/* ---------- „Éú„Éº„ÉâÁîüÊàê ---------- */
function buildBoard(mode){
  const imgArea=document.getElementById('imageArea');
  const wordArea=document.getElementById('wordArea');
  imgArea.innerHTML=''; wordArea.innerHTML='';

  const all=Object.values(wordsByCat).flat();
  const chosen=mode==='trial'
      ? all.sort(()=>0.5-Math.random()).slice(0,30)
      : wordsByCat[document.getElementById('categorySelect').value];

  /* ÁîªÂÉè„Ç´„Éº„Éâ */
  chosen.sort(()=>0.5-Math.random()).forEach(w=>{
    const d=document.createElement('div');
    d.className='img-card';
    d.textContent=emoji[w]||w;
    d.dataset.word=w;
    d.addEventListener('dragover',e=>e.preventDefault());
    d.addEventListener('drop',handleDrop);
    imgArea.appendChild(d);
  });

  /* ÂçòË™û„Ç´„Éº„Éâ */
  chosen.sort(()=>0.5-Math.random()).forEach(w=>{
    const d=document.createElement('div');
    d.className='word-card';
    d.textContent=addArticle(w);
    d.dataset.word=w;
    d.draggable=true;
    d.addEventListener('dragstart',()=>{draggedWord=w;speak(addArticle(w));});
    d.addEventListener('click',()=>speak(addArticle(w)));        // „Çø„ÉÉ„Éó„Åß„ÇÇÁô∫Â£∞
    wordArea.appendChild(d);
  });
}

/* ---------- „Éâ„É≠„ÉÉ„ÉóÂà§ÂÆö ---------- */
function handleDrop(e){
  const img=e.currentTarget;
  if(img.dataset.word===draggedWord){
    img.classList.add('matched','correct-anim');
    const pair=document.querySelector(`.word-card[data-word="${draggedWord}"]`);
    pair?.classList.add('matched','correct-anim');
    setTimeout(()=>{img.style.display='none';pair&&(pair.style.display='none');},200);

    /* Trial ÁµÇ‰∫ÜÂà§ÂÆö */
    if(document.getElementById('timer').style.display==='inline'){
      if(!document.querySelectorAll('.img-card:not([style*="display: none"])').length){
        clearInterval(timerInt);
        const sec=document.getElementById('timer').textContent.replace('Time: ','').replace('s','');
        speak(`${sec} seconds! Great job!`);
      }
    }
  }else{
    img.classList.add('wrong-anim');
    setTimeout(()=>img.classList.remove('wrong-anim'),350);
  }
}

/* ---------- „Çø„ÉÉ„ÉÅ„Éâ„É©„ÉÉ„Ç∞ ---------- */
document.addEventListener('touchstart',e=>{
  const base=e.target.closest('.word-card');
  if(!base||base.classList.contains('matched')) return;
  draggedWord=base.dataset.word; speak(addArticle(draggedWord));

  touchClone=base.cloneNode(true);
  Object.assign(touchClone.style,{
    position:'absolute',pointerEvents:'none',zIndex:1000,opacity:.7,
    width:base.offsetWidth+'px',height:base.offsetHeight+'px',
    lineHeight:getComputedStyle(base).lineHeight,
    fontSize:getComputedStyle(base).fontSize,
    padding:getComputedStyle(base).padding
  });
  document.body.appendChild(touchClone);
});
document.addEventListener('touchmove',e=>{
  if(!touchClone||!e.touches.length) return;
  const t=e.touches[0];
  touchClone.style.left=(t.pageX-touchClone.offsetWidth/2)+'px';
  touchClone.style.top =(t.pageY-touchClone.offsetHeight/2)+'px';
});
document.addEventListener('touchend',e=>{
  if(!touchClone) return;
  const el=document.elementFromPoint(e.changedTouches[0].clientX,e.changedTouches[0].clientY);
  const img=el?.closest('.img-card'); if(img) handleDrop({currentTarget:img});
  touchClone.remove(); touchClone=null;
});

/* ---------- „Çø„Ç§„Éû„Éº ---------- */
function startTimer(){
  const tm=document.getElementById('timer');
  const st=Date.now();
  clearInterval(timerInt);
  timerInt=setInterval(()=>tm.textContent='Time: '+Math.floor((Date.now()-st)/1000)+'s',500);
}

/* ---------- „Ç≤„Éº„É†ÈñãÂßã ---------- */
function startGame(mode){
  document.getElementById('startScreen').style.display='none';
  const gs=document.getElementById('gameScreen'); gs.style.display='flex';

  const catSel=document.getElementById('categorySelect');
  const stBtn =document.getElementById('startCategoryBtn');
  const timer =document.getElementById('timer');

  if(mode==='trial'){
    catSel.style.display='none'; stBtn.style.display='none'; timer.style.display='inline';
    startTimer(); buildBoard('trial');
  }else{
    catSel.style.display='inline'; stBtn.style.display='inline'; timer.style.display='none';
  }
}

/* ---------- ÂàùÊúüÂåñ ---------- */
document.addEventListener('DOMContentLoaded',()=>{
  /* „Éú„Çø„É≥ */
  document.getElementById('practiceBtn').addEventListener('click',()=>startGame('practice'));
  document.getElementById('trialBtn')   .addEventListener('click',()=>startGame('trial'));
  document.getElementById('backBtn')    .addEventListener('click',()=>{
    document.getElementById('gameScreen').style.display='none';
    document.getElementById('startScreen').style.display='block';
  });
  document.getElementById('startCategoryBtn').addEventListener('click',()=>buildBoard('practice'));

  /* „Ç´„ÉÜ„Ç¥„É™„ÉºÈÅ∏ÊäûËÇ¢ */
  const sel=document.getElementById('categorySelect');
  Object.keys(wordsByCat).forEach(c=>{
    const o=document.createElement('option'); o.value=o.textContent=c; sel.appendChild(o);
  });

  /* „Éú„Ç§„ÇπÂÖàË™≠„Åø */
  speechSynthesis.getVoices();
});
</script>
</body>
</html>
